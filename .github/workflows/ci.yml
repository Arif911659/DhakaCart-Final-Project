name: Continuous Integration (CI)

# This workflow runs automatically when you push code
# It tests your code and builds Docker images

on:
  # Trigger on every push to any branch
  push:
    branches: [ main, develop, feature/* ]
  # Trigger on pull requests
  pull_request:
    branches: [ main, develop ]

# Jobs run in parallel (faster)
jobs:
  # Job 1: Test Backend Code
  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Get the code from GitHub
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Step 2: Set up Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      # Step 3: Install dependencies
      - name: Install backend dependencies
        working-directory: ./backend
        run: |
          # Try npm ci first (faster, more reliable)
          # If it fails due to lock file mismatch, use npm install
          npm ci || {
            echo "⚠️ package-lock.json out of sync, updating..."
            npm install
            echo "✅ Dependencies installed (lock file updated)"
          }
      
      # Step 4: Run tests (if tests exist)
      - name: Run backend tests
        working-directory: ./backend
        run: npm test || echo "Tests not implemented yet - skipping"
        continue-on-error: true  # Don't fail if tests don't exist yet
      
      # Step 5: Check code quality (linting)
      - name: Check backend code quality
        working-directory: ./backend
        run: |
          echo "Code quality check - placeholder"
          # You can add ESLint here later: npm run lint
        continue-on-error: true

  # Job 2: Test Frontend Code
  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Get the code
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Step 2: Set up Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      # Step 3: Install dependencies
      - name: Install frontend dependencies
        working-directory: ./frontend
        run: |
          # Try npm ci first (faster, more reliable)
          # If it fails due to lock file mismatch, use npm install
          npm ci || {
            echo "⚠️ package-lock.json out of sync, updating..."
            npm install
            echo "✅ Dependencies installed (lock file updated)"
          }
      
      # Step 4: Run tests
      - name: Run frontend tests
        working-directory: ./frontend
        run: npm test -- --watchAll=false --coverage || echo "Tests skipped"
        continue-on-error: true
      
      # Step 5: Build frontend (check if it compiles)
      - name: Build frontend
        working-directory: ./frontend
        run: npm run build
        env:
          REACT_APP_API_URL: http://localhost:5000/api

  # Job 3: Build Docker Images (Test Build)
  build-docker-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]  # Wait for tests to pass
    
    steps:
      # Step 1: Get the code
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Step 2: Set up Docker Buildx (for building images)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      # Step 3: Build backend image (test build)
      - name: Build backend Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: false  # Don't push, just test build
          tags: arifhossaincse22/dhakacart-backend:test
          cache-from: type=registry,ref=arifhossaincse22/dhakacart-backend:latest
          cache-to: type=inline
      
      # Step 4: Build frontend image (test build)
      - name: Build frontend Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: false  # Don't push, just test build
          tags: arifhossaincse22/dhakacart-frontend:test
          cache-from: type=registry,ref=arifhossaincse22/dhakacart-frontend:latest
          cache-to: type=inline

  # Job 4: Security Scanning (Optional but recommended)
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Get the code
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Step 2: Scan Docker images for vulnerabilities
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true  # Don't fail build on vulnerabilities (for now)
      
      # Step 3: Upload scan results
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true

