apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-alert-rules
  namespace: monitoring
data:
  alert-rules.yml: |
    groups:
      - name: dhakacart_alerts
        interval: 30s
        rules:
          # High Error Rate Alert
          - alert: HighErrorRate
            expr: |
              (
                sum(rate(http_requests_total{status=~"5.."}[5m])) / 
                sum(rate(http_requests_total[5m]))
              ) > 0.01
            for: 5m
            labels:
              severity: critical
              component: backend
            annotations:
              summary: "High error rate detected" 
              description: "Error rate is {{ $value | humanizePercentage }} (threshold: 1%)"
          
          # High Latency Alert
          - alert: HighLatency
            expr: |
              histogram_quantile(0.95, 
                sum(rate(http_request_duration_seconds_bucket[5m])) by (le)
              ) > 2
            for: 5m
            labels:
              severity: warning
              component: backend
            annotations:
              summary: "High latency detected"
              description: "P95 latency is {{ $value }}s (threshold: 2s)"
          
          # Pod Down Alert
          - alert: PodDown
            expr: |
              kube_deployment_status_replicas_available{namespace="dhakacart"} < 
              kube_deployment_spec_replicas{namespace="dhakacart"}
            for: 2m
            labels:
              severity: critical
              component: kubernetes
            annotations:
              summary: "Pod(s) down in {{ $labels.deployment }}"
              description: "{{ $labels.deployment }} has {{ $value }} pods available (expected {{ $labels.spec_replicas }})"
          
          # High Memory Usage Alert  
          - alert: HighMemoryUsage
            expr: |
              (
                container_memory_working_set_bytes{namespace="dhakacart",container!=""} / 
                container_spec_memory_limit_bytes{namespace="dhakacart",container!=""} 
              ) > 0.9
            for: 5m
            labels:
              severity: warning
              component: kubernetes
            annotations:
              summary: "High memory usage in {{ $labels.pod }}"
              description: "Memory usage is {{ $value | humanizePercentage }} (threshold: 90%)"
          
          # High CPU Usage Alert
          - alert: HighCPUUsage
            expr: |
              (
                sum(rate(container_cpu_usage_seconds_total{namespace="dhakacart",container!=""}[5m])) by (pod) /
                sum(container_spec_cpu_quota{namespace="dhakacart",container!=""}/container_spec_cpu_period{namespace="dhakacart",container!=""}) by (pod)
              ) > 0.8
            for: 5m
            labels:
              severity: warning
              component: kubernetes
            annotations:
              summary: "High CPU usage in {{ $labels.pod }}"
              description: "CPU usage is {{ $value | humanizePercentage }} (threshold: 80%)"
          
          # Database Connection Issues
          - alert: DatabaseConnectionFailed
            expr: |
              up{job="kubernetes-pods",app="dhakacart-db"} == 0
            for: 1m
            labels:
              severity: critical
              component: database
            annotations:
              summary: "Database is down"
              description: "PostgreSQL database is not responding"
          
          # Redis Connection Issues
          - alert: RedisConnectionFailed
            expr: |
              up{job="kubernetes-pods",app="dhakacart-redis"} == 0
            for: 1m
            labels:
              severity: critical
              component: cache
            annotations:
              summary: "Redis is down"
              description: "Redis cache is not responding"
